{"version":3,"sources":["NativeBinder.ts"],"names":["MODULE_NAME","NativeModule","NativeModules","NoopModuleProxy","Proxy","get","Error","LINKING_ERROR","CallsEvent","DefaultEventType","DirectCallEventType","GroupCallEventType","NativeBinder","nativeModule","_nativeModule","jsEventEmitter","_jsEventEmitter","constructor","NativeEventEmitter","JSEventEmitter","DEFAULT","DIRECT_CALL","GROUP_CALL","_supportedNativeEvents","forEach","event","Logger","info","_nativeEventEmitter","addListener","eventType","data","additionalData","roomId","callId","JSON","stringify","slice","join","emit","type","eventName","callback"],"mappings":"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","sourcesContent":["/* eslint-disable */\nimport { NativeEventEmitter, NativeModules } from 'react-native';\n\nimport type { AsNativeInterface, DirectCallProperties, RoomProperties, SendbirdCallsNativeSpec } from '../types';\nimport { LINKING_ERROR } from '../utils/constants';\nimport { convertDirectCallPropsNTJ, convertGroupCallPropsNTJ } from '../utils/converter';\nimport { Logger } from '../utils/logger';\nimport JSEventEmitter from './JSEventEmitter';\n\nconst MODULE_NAME = 'RNSendbirdCalls';\nconst NativeModule = NativeModules[MODULE_NAME]; //TurboModuleRegistry.get<SendbirdCallsSpec>(MODULE_NAME);\n\nconst NoopModuleProxy = new Proxy(\n  {},\n  {\n    get() {\n      throw new Error(LINKING_ERROR);\n    },\n  },\n);\n\nexport enum CallsEvent {\n  DEFAULT = 'sendbird.call.default',\n  DIRECT_CALL = 'sendbird.call.direct',\n  GROUP_CALL = 'sendbird.call.group',\n}\n\nexport enum DefaultEventType {\n  ON_RINGING = 'sendbird.call.default.onRinging',\n}\n\nexport enum DirectCallEventType {\n  ON_ESTABLISHED = 'sendbird.call.direct.onEstablished',\n  ON_CONNECTED = 'sendbird.call.direct.onConnected',\n  ON_RECONNECTING = 'sendbird.call.direct.onReconnecting',\n  ON_RECONNECTED = 'sendbird.call.direct.onReconnected',\n  ON_ENDED = 'sendbird.call.direct.onEnded',\n  ON_REMOTE_AUDIO_SETTINGS_CHANGED = 'sendbird.call.direct.onRemoteAudioSettingsChanged',\n  ON_REMOTE_VIDEO_SETTINGS_CHANGED = 'sendbird.call.direct.onRemoteVideoSettingsChanged',\n  ON_LOCAL_VIDEO_SETTINGS_CHANGED = 'sendbird.call.direct.onLocalVideoSettingsChanged',\n  ON_REMOTE_RECORDING_STATUS_CHANGED = 'sendbird.call.direct.onRemoteRecordingStatusChanged',\n  ON_AUDIO_DEVICE_CHANGED = 'sendbird.call.direct.onAudioDeviceChanged',\n  ON_CUSTOM_ITEMS_UPDATED = 'sendbird.call.direct.onCustomItemsUpdated',\n  ON_CUSTOM_ITEMS_DELETED = 'sendbird.call.direct.onCustomItemsDeleted',\n  ON_USER_HOLD_STATUS_CHANGED = 'sendbird.call.direct.onUserHoldStatusChanged',\n}\n\nexport enum GroupCallEventType {\n  ON_DELETED = 'sendbird.call.group.onDeleted',\n  ON_ERROR = 'sendbird.call.group.onError',\n  ON_REMOTE_PARTICIPANT_ENTERED = 'sendbird.call.group.onRemoteParticipantEntered',\n  ON_REMOTE_PARTICIPANT_EXITED = 'sendbird.call.group.onRemoteParticipantExited',\n  ON_REMOTE_PARTICIPANT_STREAM_STARTED = 'sendbird.call.group.onRemoteParticipantStreamStarted',\n  ON_AUDIO_DEVICE_CHANGED = 'sendbird.call.group.onAudioDeviceChanged',\n  ON_REMOTE_VIDEO_SETTINGS_CHANGED = 'sendbird.call.group.onRemoteVideoSettingsChanged',\n  ON_REMOTE_AUDIO_SETTINGS_CHANGED = 'sendbird.call.group.onRemoteAudioSettingsChanged',\n  ON_CUSTOM_ITEMS_UPDATED = 'sendbird.call.group.onCustomItemsUpdated',\n  ON_CUSTOM_ITEMS_DELETED = 'sendbird.call.group.onCustomItemsDeleted',\n}\n\ntype MakeEventUnionMember<Type, Data> = {\n  eventType: Type;\n  data: AsNativeInterface<Data>;\n  convertedData: Data;\n  additionalData?: Record<string, any>;\n};\n\ntype EventUnion =\n  | MakeEventUnionMember<DefaultEventType, DirectCallProperties>\n  | MakeEventUnionMember<DirectCallEventType, DirectCallProperties>\n  | MakeEventUnionMember<GroupCallEventType, RoomProperties>;\n\ntype EventType = EventUnion['eventType'];\ntype ExtractData<T extends EventType, U extends EventUnion = EventUnion> = U extends { eventType: T }\n  ? U['convertedData']\n  : never;\n\nexport default class NativeBinder {\n  private _nativeModule: SendbirdCallsNativeSpec = NativeModule ?? NoopModuleProxy;\n  private _nativeEventEmitter = new NativeEventEmitter(this._nativeModule);\n  private _jsEventEmitter = new JSEventEmitter();\n  private _supportedNativeEvents = [CallsEvent.DEFAULT, CallsEvent.DIRECT_CALL, CallsEvent.GROUP_CALL];\n\n  public get nativeModule() {\n    return this._nativeModule;\n  }\n  public get jsEventEmitter() {\n    return this._jsEventEmitter;\n  }\n\n  constructor() {\n    /* for reduce redundant native event listeners */\n    this._supportedNativeEvents.forEach((event) => {\n      Logger.info('[NativeBinder] Add native event listener:', event);\n\n      // Native -> JS\n      this._nativeEventEmitter.addListener(\n        event,\n        ({ eventType, data, additionalData }: Omit<EventUnion, 'convertedData'>) => {\n          Logger.info(\n            '[NativeBinder] Receive events from native module: ',\n            [\n              event,\n              eventType,\n              event === CallsEvent.GROUP_CALL\n                ? (data as AsNativeInterface<RoomProperties>).roomId\n                : (data as AsNativeInterface<DirectCallProperties>).callId,\n              additionalData && JSON.stringify(additionalData).slice(0, 30) + '...',\n            ].join(' ++ '),\n          );\n\n          if (event === CallsEvent.DIRECT_CALL || event === CallsEvent.DEFAULT) {\n            this.jsEventEmitter.emit(event, {\n              type: eventType,\n              data: convertDirectCallPropsNTJ(data as AsNativeInterface<DirectCallProperties>),\n              additionalData,\n            });\n          }\n\n          if (event === CallsEvent.GROUP_CALL) {\n            this.jsEventEmitter.emit(event, {\n              type: eventType,\n              data: convertGroupCallPropsNTJ(data as AsNativeInterface<RoomProperties>),\n              additionalData,\n            });\n          }\n        },\n      );\n    });\n  }\n\n  public addListener(eventName: CallsEvent.DEFAULT, callback: EventCallback<DefaultEventType>): () => void;\n  public addListener(eventName: CallsEvent.DIRECT_CALL, callback: EventCallback<DirectCallEventType>): () => void;\n  public addListener(eventName: CallsEvent.GROUP_CALL, callback: EventCallback<GroupCallEventType>): () => void;\n  public addListener(eventName: string, callback: (event: any) => void) {\n    Logger.info('[NativeBinder] Add javascript event listener:', eventName);\n    return this.jsEventEmitter.addListener(eventName, callback);\n  }\n}\n\ntype EventCallback<T extends EventType> = (data: {\n  type: T;\n  data: ExtractData<T>;\n  additionalData?: Record<string, any>;\n}) => void;\n"]}